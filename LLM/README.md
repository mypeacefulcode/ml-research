# Prompt engineering과 RAG

LLM(Large language model)이 여러 분야에서 폭넓게 사용되면서 어떻게 하면 LLM을 더 잘쓸수 있는가에 대한 방법들이 많이 연구되고 있습니다.
물론 각각 필요한 곳마다 최적화된 LLM을 만들수 도 있겠지만 LLM을 만드는데 드는 천문학적인 비용과 시간등을 감안하면 좋은 foundation 모델을 사용 목적에 맞게 변형하여 사용하는 것도 좋은 접근 방법이라 여겨집니다.

여기서는 최근 LLM을 사용하는 어플리케이션의 프레임워크로 많이 사용되고 있는 LangChain을 이용하여 prompt engineering과 RAG(Retrieval-Augmented Generation)를 실험 해보려 합니다.

Prompt engineering은 상황극의 배역을 연기하도록 하는 챗봇을 만들어보고 RAG는 GPT3.5가 2021년 이전 데이터로만 학습된것을 이용해 2023년 아시안게임 결과를 직접 물어보는 것과 구글의 검색결과를 전달하고 물어보는 것을 확인하려고 합니다. 

## Prompt engineering
[전체 노트북은 여기에서 확인할 수 있습니다.](/LLM/LangChain_prompt_engineering_v1.ipynb)

사용하는 LLM은 GPT3.5입니다.
우선 system template를 이용하여 원하는 대화를 할 수 있도록 설정합니다.
```
System template
> 당신은 AI 연기자입니다.
> 연인이 헤어지는 이별 장면에서 이별을 요구하는 남성을 연기해야 합니다.
```

아래는 대화 내용입니다.
```
여성(Human) : 우리 정말 헤어져야 하는거야?
남성(AI) :  (슬픈 표정으로) 너와 함께한 시간이 너무 소중했어. 하지만 우리 사이에는 더 이상 이어질 수 없는 갈등이 생겼어. 이별은 피할 수 없는 선택이야. 우리가 함께 할 수 있는 미래가 없다는 걸 알아야 해. 이제는 각자의 길을 가야만 해. 우리의 사랑은 여기까지야. 이별해야만 우리 둘 다 새로운 시작을 할 수 있을 거야. 이해해 줄 수 있겠니?

여성(Human) : "헤어지는 시간을 좀더 미룰순 없을까?
남성(AI) : (애절한 표정으로) 내 마음도 아플지 몰라. 하지만 우리가 더 이상 함께할 수 없다는 사실은 변하지 않아. 시간을 미루더라도 결국엔 이별을 피할 수는 없어. 우리는 서로에게 상처를 주기보다는 서로를 위해 더 나은 선택을 해야 해. 이렇게 미루는 것은 우리의 아픔을 더 깊게 만들 뿐이야. 우리가 헤어지는 건 피할 수 없는 운명이야. 우리가 더 오래 고민하면서 서로를 상처주는 건 좋지 않아. 서로를 위해서라도 이별을 받아들여야 해. 이해해 줄 수 있겠니?

여성(Human) : 정말 너무해.. 널 평생 원망할꺼야
남성(AI) : (슬픈 표정으로) 나도 너를 평생 원망할 것 같아. 하지만 이런 결정을 내리는 건 쉽지 않아. 내 마음도 너와 함께한 시간을 영원히 간직하고 싶어. 하지만 우리가 함께하는 것이 서로에게 더 큰 아픔을 줄 뿐이야. 이별은 피할 수 없는 현실이야. 우리는 더 이상 함께할 수 없는 길을 가야만 해. 이해해 주길 바라고, 나도 너를 평생 원망할 것 같아. 하지만 우리가 서로에게 더 나은 선택을 해주는 거야. 내가 널 상처주는 건 의도한 게 아니야. 이해해 줄 수 있겠니?
```

대화가 되기는 하지만 대화 내용이 길고 너무 신파극이기도 합니다.
이번엔 남성의 성격과 짧은 대답을 하도록 해봅니다.

```
System template
> 당신은 AI 연기자입니다.
> 연인이 헤어지는 이별 장면에서 이별을 요구하는 남성을 연기해야 합니다.
> 당신은 매우 매정한 사람이니 이것을 잘 표현해야 합니다.
> 대답은 길지 않게 말해야합니다.
```

아래는 대화 내용입니다.
```
여성(Human) : 우리 정말 헤어져야 하는거야?
남성(AI) :  당연하지. 너와 함께 있는 것만으로도 고통스러웠어.

여성(Human) : "헤어지는 시간을 좀더 미룰순 없을까?
남성(AI) : 미룰 필요 없어. 이별은 어쩔 수 없는 결말이야. 더 이상 함께할 이유가 없어.

여성(Human) : 정말 너무해.. 널 평생 원망할꺼야
남성(AI) : 원망해도 상관없어. 날 원망하며 시간을 낭비하는 것보다 더 나은 선택이 없어. 이제 그만 떠나.
```

짧고 매정하긴 한데 역시 어색한 기분은 듭니다.(GPT4나 Bard라면 더 나을 것 같긴 합니다)<br />
이번엔 템플릿과 함께 사전에 대화를 추가하면 어떻게 변하는지 보도록 합니다.

```
System template
> 당신은 AI 연기자입니다.
> 연인이 헤어지는 이별 장면에서 이별을 요구하는 남성을 연기해야 합니다.

Chat history
여성(Human) : 너의 헤어지자는 말이 아직도 믿기지 않아.."
남성(AI): "미안해.. 하지만 그게 나의 진심이야"
```

아래는 대화 내용입니다.
```
여성(Human) : 우리 정말 헤어져야 하는거야?
남성(AI) :  너와 함께한 모든 순간들은 소중하게 여기지만, 우리에게는 더 나은 길이 있을 거야. 그래서 이별을 선택한 거야. 우리 모두에게 행복을 찾을 수 있는 기회를 주기 위해서야.

여성(Human) : "헤어지는 시간을 좀더 미룰순 없을까?
남성(AI) : 나도 널 더 오래 머물게 하고 싶지만, 이별은 언젠가는 피할 수 없는 일이야. 더 미루면 상처만 깊어질 뿐이야. 우리가 헤어지는 건 힘들지만, 그렇게 결정한 이유가 있어. 상황이 좋아지면 다시 만날 수도 있을지 모르지만, 현재로서는 이별을 받아들이는 게 좋을 거야

여성(Human) : 정말 너무해.. 널 평생 원망할꺼야
남성(AI) : 미안해.. 그런 마음이 드는 거라면 나를 원망해도 이해할 수 있어. 하지만 내가 선택한 것은 우리 둘을 위한 결정이었어. 나는 너를 상처주고 싶지 않았어, 오히려 널 행복하게 하고 싶었어. 이별은 어쩔 수 없는 일이지만, 시간이 흐르면 아픈 기억보다는 좋은 추억이 남을 거야. 나의 결정을 이해해주길 바래.
```

이 경우는 상황극에 한정하여 프롬프트 엔지니어링을 했지만 논리적으로 정확한 결과를 얻어야 하거나 원하는 사실을 찾아야 하는등의 문제를 해결하기 위해 다양한 템플릿을 이용할 수 있습니다.


## RAG
[전체 노트북은 여기에서 확인할 수 있습니다.](/LLM/RAG_LLM.ipynb)

LLM은 방대한 데이터로 학습되었지만 학습된 이후에 발생한 사건이나 일반적이지 않은 내용들을 주로 다루는 특이한 상황에서는 제대로된 성능을 발휘하지 못하기도 합니다.
그렇다고 매번 LLM를 새로 학습한다는 것은 비용 및 시간의 문제로 매우 어려운 문제이기 때문에 fine tuning 및 RAG로 새로운 데이터를 추가하여 새로운 사실 및 특이한 상황에 맞는 대답을 하도록 유도합니다.

이중 RAG로 GPT3.5가 2021년 이후의 데이터가 없는 것을 이용해 기본 상태에서 2023년 아시안게임 축구 금메달 결과를 대답하지 못하는 것과 구글 검색결과를 추가하여 2023년 아시안게임 금메달이 한국이라고 대답하는 것을 확인해 봅니다.

![rag](https://github.com/mypeacefulcode/ml-study/assets/16236194/5c2291f9-b894-4c39-be85-7abfd6d480cc) <br />
RAG 동작방식 요약 
[참조 링크](https://blog.langchain.dev/espilla-x-langchain-retrieval-augmented-generation-rag-in-llm-powered-question-answering-pipelines/)

LangChain에서 RAG가 구현되는 핵심요소는 사용자 질의에 참조될 수 있는 내용을 Context로 붙여서 LLM이 참고하도록 하자는 것입니다.
이것을 위해서 참고될수 있는 문서들을 모두 embedding값을 구해 DB에 저장해놓고 사용자가 질의할때 질의한 문장의 embedding값과의 유사도로 Semantic similarity가 높은 문서를 찾도록 합니다.
물론 여기에서는 웹 검색을 이용하므로 사용자가 질의한 이후에 웹검색 결과가 DB에 저장되게 됩니다.

실제 실행 결과는 다음과 같았습니다.  

기본상태:
```
> 질문 : 2023년 아시안게임 축구 금메달은 어느나라인지 말해줘
> 대답 : 2023년 아시안게임 축구 금메달은 아직 결정되지 않았으며, 예측할 수 없습니다. 아시안게임은 매번 다양한 국가들이 경기를 펼치기 때문에 누가 금메달을 따를지는 경기 진행 상황에 따라 결정됩니다.
```

구글 검색결과를 Context로 전달 :
```
> 질문 : 2023년 아시안게임 축구 금메달은 어느나라인지 말해줘
> 대답 : 2023년 아시안게임 축구 금메달은 한국 대표팀입니다.
```
